import{r as h,u as O,o as U,a as j,c as m,b as _,d as p,h as R,w as T,e as n,n as b,t as u,f as I,g as v,F as C,i as J,j as B,k as L,v as Y,l as A,m as V}from"./app-Cth6j1P5.js";import{_ as q}from"./AppLayout.vue_vue_type_script_setup_true_lang-D0vDsSc7.js";import{d as z}from"./index-CZQkL-u1.js";import"./AppLogoIcon.vue_vue_type_script_setup_true_lang-BUug_G_H.js";import"./useForwardExpose-CzyjRkTG.js";import"./VisuallyHidden-DL52O4mR.js";import"./RovingFocusGroup-7nzdUp1N.js";import"./useArrowNavigation-C6Y-ieo6.js";import"./createLucideIcon-DPVBUESF.js";const F={class:"max-w-4xl mx-auto p-6"},K={class:"bg-white rounded-lg shadow p-4 mb-6"},H={class:"flex items-center space-x-4"},P={class:"text-xl font-semibold text-gray-900"},G={class:"text-gray-600"},Q={class:"space-y-4"},W={class:"text-sm"},X={key:0,class:"text-center py-8"},Z={class:"bg-white rounded-lg shadow p-4"},ee={class:"flex items-center space-x-4"},se=["disabled"],ue={__name:"Chat",props:{user:{type:Object,required:!0},initialMessages:{type:Object,required:!0}},setup(d){const l=h(""),c=h([]),g=h(null),S=h([]),i=O(),a=d,s=e=>{const t=new Date().toLocaleTimeString();S.value.push(`${t}: ${e}`),console.log(e)},E=[{title:"Dashboard",href:z().url},{title:`Chat with ${a.user.name}`,href:"#"}],M=e=>e.split(" ").map(t=>t[0]).join("").toUpperCase(),N=e=>{const t=["bg-blue-500","bg-green-500","bg-purple-500","bg-pink-500","bg-indigo-500","bg-teal-500","bg-orange-500","bg-cyan-500","bg-amber-500"];return t[e%t.length]},f=()=>{A(()=>{g.value&&g.value.scrollTo({top:g.value.scrollHeight,behavior:"smooth"})})},w=()=>{l.value.trim()!==""&&(s(`Sending message: "${l.value}" to user ${a.user.id}`),V.post(`/messages/${a.user.id}`,{message:l.value}).then(e=>{s(`Message sent successfully: ${e.data.id}`),l.value="",f()}).catch(e=>{s(`Error sending message: ${e.response?.data?.message||e.message}`),console.error("Error sending message: ",e)}))};U(()=>{c.value=a.initialMessages,s(`Component mounted with ${a.initialMessages.length} initial messages`),s(`Chatting with user ID: ${a.user.id}`),s(`Your user ID: ${i.props.auth.user.id}`),k(),f()});const k=()=>{if(!window.Echo){s("âŒ Echo is not available on window object");return}s("ðŸ”„ Setting up Echo connection (ShouldBroadcastNow)...");const e=window.Echo.connector.pusher;e.connection.bind("connected",()=>{s("âœ… Connected to Reverb server"),y()}),e.connection.bind("connecting",()=>{s("ðŸ”„ Connecting to Reverb server...")}),e.connection.bind("disconnected",()=>{s("ðŸ”Œ Disconnected from Reverb server")}),e.connection.bind("error",t=>{s(`âŒ Connection error: ${JSON.stringify(t)}`)}),y()},y=()=>{const e=`chat.${i.props.auth.user.id}`;s(`Setting up listener for YOUR channel: ${e}`);try{const t=window.Echo.private(e);t.subscribed(()=>{s(`âœ… Successfully subscribed to YOUR channel: ${e}`)}).error(r=>{s(`âŒ Your channel subscription failed: ${JSON.stringify(r)}`)}),t.listen(".MessageSent",r=>{s(`ðŸŽ¯ MessageSent event received on your channel: ${JSON.stringify(r)}`),x(r)});const o=`chat.${a.user.id}`;s(`Also setting up listener for other user's channel: ${o}`),window.Echo.private(o).subscribed(()=>{s(`âœ… Also subscribed to other user's channel: ${o}`)}).listen(".MessageSent",r=>{s(`ðŸŽ¯ MessageSent event received on other user's channel: ${JSON.stringify(r)}`),x(r)}),t.listenToAll((r,D)=>{r!=="pusher:subscription_succeeded"&&r!=="pusher:ping"&&s(`ðŸ“¢ Your channel - ${r}: ${JSON.stringify(D)}`)})}catch(t){s(`âŒ Error setting up channels: ${t.message}`)}},x=e=>{e.message?e.message.sender_id===a.user.id&&e.message.receiver_id===i.props.auth.user.id||e.message.sender_id===i.props.auth.user.id&&e.message.receiver_id===a.user.id?(s(`âœ… Adding relevant message to UI: "${e.message.body}" (ID: ${e.message.id})`),c.value.some($=>$.id===e.message.id)?s("âš ï¸ Message already exists, skipping..."):(c.value.push(e.message),f(),e.message.sender_id!==i.props.auth.user.id&&s("ðŸ”” New message from other user"))):s(`ðŸš« Ignoring irrelevant message: ${e.message.sender_id} -> ${e.message.receiver_id}`):s(`âŒ No message data in event: ${JSON.stringify(e)}`)};return j(()=>{window.Echo&&(window.Echo.leave(`chat.${i.props.auth.user.id}`),window.Echo.leave(`chat.${a.user.id}`),s("Echo listeners cleaned up"))}),(e,t)=>(v(),m(C,null,[_(p(R),{title:`Chat with ${d.user.name}`},null,8,["title"]),_(q,{breadcrumbs:E},{default:T(()=>[n("div",F,[n("div",K,[n("div",H,[n("div",{class:b(["flex-shrink-0 h-12 w-12 rounded-full flex items-center justify-center text-white font-medium",N(d.user.id)])},u(M(d.user.name)),3),n("div",null,[n("h2",P,u(d.user.name),1),n("p",G,u(d.user.email),1)])])]),n("div",{ref_key:"messagesContainer",ref:g,class:"bg-white rounded-lg shadow h-96 overflow-y-auto p-4 mb-4"},[n("div",Q,[(v(!0),m(C,null,J(c.value,o=>(v(),m("div",{key:o.id,class:b(["flex",o.sender_id===p(i).props.auth.user.id?"justify-end":"justify-start"])},[n("div",{class:b(["max-w-xs lg:max-w-md px-4 py-2 rounded-lg",o.sender_id===p(i).props.auth.user.id?"bg-blue-500 text-white":"bg-gray-200 text-gray-900"])},[n("p",W,u(o.body),1),n("p",{class:b(["text-xs mt-1",o.sender_id===p(i).props.auth.user.id?"text-blue-100":"text-gray-500"])},u(new Date(o.created_at).toLocaleTimeString()),3)],2)],2))),128)),c.value.length===0?(v(),m("div",X,[...t[1]||(t[1]=[n("p",{class:"text-gray-500"},"No messages yet. Start the conversation!",-1)])])):I("",!0)])],512),n("div",Z,[n("div",ee,[B(n("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=o=>l.value=o),onKeyup:L(w,["enter"]),placeholder:"Type a message...",class:"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"},null,544),[[Y,l.value]]),n("button",{onClick:w,disabled:!l.value.trim(),class:"px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"}," Send ",8,se)])])])]),_:1})],64))}};export{ue as default};
