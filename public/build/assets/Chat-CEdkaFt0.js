import{r as m,u as de,w as ue,o as ce,a as me,c as l,b as z,d as h,h as pe,e as ge,f as t,g as w,i as d,t as u,n as he,j as f,F as V,k as fe,l as xe,m as ve,p as be,v as ye,q as A,s as C}from"./app-BTqllKim.js";import{_ as we}from"./AppLayout.vue_vue_type_script_setup_true_lang-3HadJBRe.js";import{d as _e}from"./index-CZQkL-u1.js";import{u as ke}from"./useNotifications-DLabTVR4.js";import"./index-AaVO4FJE.js";import"./useForwardExpose-BGOyg-5y.js";import"./VisuallyHidden-DhpBD5pj.js";import"./RovingFocusGroup-kCJbpNiJ.js";import"./useArrowNavigation-C6Y-ieo6.js";import"./createLucideIcon-D1_H_VWz.js";import"./AppLogoIcon.vue_vue_type_script_setup_true_lang-C8Viq3q1.js";const Me={class:"max-w-4xl mx-auto p-4 md:p-6"},$e={class:"mb-4"},Ce={key:0,class:"flex items-center space-x-2 text-xs md:text-sm text-green-600"},De={key:1,class:"text-xs md:text-sm text-gray-500"},Se={key:0,class:"mb-4 bg-blue-50 border border-blue-200 rounded-lg p-3 md:p-4"},Ee={class:"flex items-center space-x-3"},Ue={class:"flex-1"},je={class:"w-full bg-blue-200 rounded-full h-1.5 md:h-2 mt-1"},Be={class:"text-xs text-blue-600 mt-1"},Te={class:"bg-white rounded-lg shadow p-3 md:p-4 mb-4 md:mb-6"},Ne={class:"flex flex-col md:flex-row md:justify-between md:items-center space-y-3 md:space-y-0"},Ie={class:"flex items-center space-x-3 md:space-x-4"},Oe={class:"flex-1 min-w-0"},Re={class:"text-lg md:text-xl font-semibold text-gray-900 truncate"},Fe={class:"text-xs md:text-sm text-gray-600 truncate"},Pe={key:0,class:"flex items-center space-x-2 text-xs md:text-sm text-green-600 mt-1"};const Le={class:"space-y-3 md:space-y-4"},ze={class:"max-w-[80%] md:max-w-xs lg:max-w-md"},Ve={key:0,class:"mb-1"},Ae={class:"bg-gray-100 border-l-2 border-gray-300 pl-2 py-1 text-xs text-gray-600 rounded"},Je={class:"truncate"},Ye=["onClick"],qe={key:0,class:"mb-2"},Ge=["src","alt","onClick"],He={key:1,class:"flex items-center space-x-2 md:space-x-3"},Ke={class:"flex-shrink-0 text-xl md:text-2xl"},We={class:"flex-1 min-w-0"},Xe={class:"flex-shrink-0"},Ze=["onClick"],Qe={class:"text-sm break-words"},es={key:0,class:"text-center py-6 md:py-8"},ss={key:1,class:"mb-3 md:mb-4 p-2 md:p-3 bg-blue-50 border-l-2 md:border-l-4 border-blue-500 rounded-lg shadow-sm"},ts={class:"flex justify-between items-start"},os={class:"flex-1 min-w-0"},ns={class:"flex items-center space-x-1 md:space-x-2 mb-1"},as={class:"text-xs md:text-sm font-medium text-blue-700 truncate"},is={class:"pl-4 md:pl-6"},rs={class:"text-xs md:text-sm text-blue-600 bg-blue-100 px-2 py-1 md:px-3 md:py-2 rounded truncate"},ls={class:"bg-white rounded-lg shadow p-3 md:p-4"},ds={class:"flex items-center space-x-2 md:space-x-4"},us=["disabled"],ks={__name:"Chat",props:{user:{type:Object,required:!0},initialMessages:{type:Object,required:!0}},setup(x){const y=m(""),p=m([]),D=m(null),J=m([]),r=de(),T=m(!1),U=m(!1),g=m(null),S=m(null),E=m(null),_=m(!1),v=m(0),k=m(null),b=m(!1),{addNotification:N,markAsRead:I,clearNotifications:O}=ke(),i=x,Y=()=>{if(window.Echo)try{return window.Echo.join("online-users").here(s=>{n(`Users currently online: ${s.length}`);const o=s.some(a=>a.id===i.user.id);b.value=o}).joining(s=>{n(`User joining: ${s.name}`),s.id===i.user.id&&(b.value=!0)}).leaving(s=>{n(`User leaving: ${s.name}`),s.id===i.user.id&&(b.value=!1)}).listen(".UserOnlineStatusUpdated",s=>{n(`Online status update received: ${JSON.stringify(s)}`),s.user&&s.user.id===i.user.id&&(b.value=s.is_online)}),()=>{window.Echo.leave("online-users")}}catch(e){console.error("Online listener error:",e)}return()=>{}};ue(()=>i.user,e=>{b.value=e.is_online},{immediate:!0});const n=e=>{const s=new Date().toLocaleTimeString();J.value.push(`${s}: ${e}`),console.log(e)},q=[{title:"Dashboard",href:_e().url},{title:`Chat with ${i.user.name}`,href:"#"}],G=e=>e.split(" ").map(s=>s[0]).join("").toUpperCase(),H=e=>{const s=["bg-blue-500","bg-green-500","bg-purple-500","bg-pink-500","bg-indigo-500","bg-teal-500","bg-orange-500","bg-cyan-500","bg-amber-500"];return s[e%s.length]},M=()=>{A(()=>{D.value&&D.value.scrollTo({top:D.value.scrollHeight,behavior:"smooth"})})},K=e=>e.sender_id===r.props.auth.user.id?"You":i.user.name,j=e=>{T.value=e,C.post(`/typing/${i.user.id}`,{is_typing:e}).then(()=>{n(`Typing status sent: ${e}`)}).catch(s=>{console.error("Error sending typing status:",s)})},R=()=>{k.value&&(k.value.currentTime=0,k.value.play().catch(e=>console.log("Audio play failed:",e)))},W=()=>{T.value||j(!0),clearTimeout(S.value),S.value=setTimeout(()=>{j(!1)},1e3)},F=()=>{if(y.value.trim()!==""){const e={message:y.value};g.value&&(e.reply_to=g.value.id),C.post(`/messages/${i.user.id}`,e).then(s=>{n(`Message sent successfully: ${s.data.id}`),y.value="",B(),j(!1),clearTimeout(S.value),M()}).catch(s=>{n(`Error sending message: ${s.response?.data?.message||s.message}`),console.error("Error sending message: ",s)})}},X=e=>{g.value=e,n(`Replying to message: ${e.body.substring(0,30)}...`),A(()=>{document.querySelector('input[type="text"]')?.focus()})},B=()=>{g.value=null},Z=()=>{confirm("Are you sure you want to clear all messages in this chat? This will only clear messages for you. The other user will still see them.")&&C.delete(`/messages/${i.user.id}/clear`).then(e=>{p.value=[],n("Messages cleared locally"),O(i.user.id),alert(e.data.message||"Messages cleared successfully (for you only)")}).catch(e=>{n(`Error clearing messages: ${e.response?.data?.message||e.message}`),console.error("Error clearing messages: ",e),alert("Error clearing messages. Please try again.")})},Q=()=>{E.value?.click()},ee=e=>{const s=e.target.files[0];s&&P(s),e.target.value=""},P=e=>{if(!e)return;const s=20*1024*1024;if(e.size>s){alert("File is too large. Maximum size is 20MB.");return}_.value=!0,v.value=0;const o=new FormData;o.append("file",e),g.value&&o.append("reply_to",g.value.id),E.value&&(E.value.value=""),C.post(`/messages/${i.user.id}/upload`,o,{headers:{"Content-Type":"multipart/form-data",Accept:"application/json"},onUploadProgress:a=>{if(a.total){const c=Math.round(a.loaded*100/a.total);v.value=c}}}).then(a=>{v.value=100,a.data.success&&a.data.message?(n(`File uploaded successfully: ${a.data.message.file_name}`),n(`Message type: ${a.data.message.type}`),p.value.some($=>$.id===a.data.message.id)||(p.value.push(a.data.message),M())):n("Upload response format unexpected:",a.data),B(),setTimeout(()=>{_.value=!1,v.value=0},500)}).catch(a=>{_.value=!1,v.value=0;let c="Failed to upload file";a.response?.data?.error?c=a.response.data.error:a.response?.data?.message?c=a.response.data.message:a.message&&(c=a.message),n(`Error uploading file: ${c}`),alert(`Upload failed: ${c}`),console.error("Upload error details:",a)})},se=e=>{e.preventDefault(),e.stopPropagation();const s=e.dataTransfer.files;s.length>0&&P(s[0])},te=e=>{e.preventDefault(),e.stopPropagation(),e.dataTransfer.dropEffect="copy"},oe=e=>e?e.includes("image")?"ðŸ“·":e.includes("pdf")?"ðŸ“„":e.includes("word")||e.includes("document")?"ðŸ“":e.includes("excel")||e.includes("spreadsheet")?"ðŸ“Š":e.includes("powerpoint")||e.includes("presentation")?"ðŸ“ˆ":e.includes("zip")||e.includes("rar")||e.includes("archive")?"ðŸ“¦":"ðŸ“Ž":"ðŸ“Ž",ne=e=>{e.file_url&&window.open(e.file_url,"_blank")};ce(()=>{p.value=i.initialMessages,n(`Component mounted with ${i.initialMessages.length} initial messages`),n(`Chatting with user ID: ${i.user.id}`),n(`Your user ID: ${r.props.auth.user.id}`),b.value=i.user.is_online||i.user.last_seen_at&&new Date(i.user.last_seen_at)>new Date(Date.now()-180*1e3);const e=Y();k.value=new Audio("/notification.mp3"),k.value.volume=.3,I(i.user.id),ie(),M(),me(()=>{e&&e(),window.Echo&&(window.Echo.leave(`chat.${r.props.auth.user.id}`),n("Echo listeners cleaned up")),clearTimeout(S.value)})});const ae=e=>{if(!e)return"a while ago";const s=new Date(e),a=new Date-s,c=Math.floor(a/6e4);if(c<1)return"just now";if(c<60)return`${c} minutes ago`;const $=Math.floor(c/60);return $<24?`${$} hours ago`:`${Math.floor($/24)} days ago`},ie=()=>{if(!window.Echo){n("âŒ Echo is not available on window object");return}n("ðŸ”„ Setting up Echo connection...");const e=window.Echo.connector.pusher;e.connection.bind("connected",()=>{n("âœ… Connected to Reverb server"),L()}),e.connection.bind("connecting",()=>{n("ðŸ”„ Connecting to Reverb server...")}),e.connection.bind("disconnected",()=>{n("ðŸ”Œ Disconnected from Reverb server")}),e.connection.bind("error",s=>{n(`âŒ Connection error: ${JSON.stringify(s)}`)}),L()},L=()=>{const e=`chat.${r.props.auth.user.id}`;n(`Setting up listener for YOUR channel: ${e}`);try{const s=window.Echo.private(e);s.subscribed(()=>{n(`âœ… Successfully subscribed to YOUR channel: ${e}`)}).error(o=>{n(`âŒ Your channel subscription failed: ${JSON.stringify(o)}`)}),s.listen(".MessageSent",o=>{n(`ðŸŽ¯ MessageSent event received: ${JSON.stringify(o)}`),re(o)}),s.listenToAll((o,a)=>{o!=="pusher:subscription_succeeded"&&o!=="pusher:ping"&&n(`ðŸ“¢ Your channel - ${o}: ${JSON.stringify(a)}`)})}catch(s){n(`âŒ Error setting up channels: ${s.message}`)}},re=e=>{if(e.isTypingUpdate){n(`Typing update: User ${e.userId} is typing: ${e.isTyping}`),e.userId===r.props.auth.user.id||e.userId===i.user.id&&(U.value=e.isTyping,setTimeout(()=>{U.value=!1},2e3));return}if(e.isClearMessages){n(`Messages cleared for user ${e.clearedForUserId}`),e.clearedForUserId===r.props.auth.user.id&&(p.value=[],n("Clearing messages from UI for current user"),O(i.user.id));return}e.message?(n(`Incoming message - Type: ${e.message.type}, Body: "${e.message.body}"`),n(`Message data: ${JSON.stringify(e.message)}`),e.message.sender_id===i.user.id&&e.message.receiver_id===r.props.auth.user.id||e.message.sender_id===r.props.auth.user.id&&e.message.receiver_id===i.user.id?(n(`âœ… Adding relevant message to UI: "${e.message.body}" (ID: ${e.message.id})`),p.value.some(a=>a.id===e.message.id)?n("âš ï¸ Message already exists, skipping..."):(p.value.push(e.message),M(),e.message.sender_id===i.user.id&&(R(),N(i.user.id)))):(n(`ðŸš« Ignoring irrelevant message: ${e.message.sender_id} -> ${e.message.receiver_id}`),e.message.sender_id!==r.props.auth.user.id&&e.message.receiver_id===r.props.auth.user.id&&(R(),N(e.message.sender_id)))):n(`âŒ No message data in event: ${JSON.stringify(e)}`)},le=()=>{C.get(`/messages/${i.user.id}`).then(e=>{p.value=e.data,I(i.user.id),M()}).catch(e=>{console.error("Error loading messages: ",e)})};return(e,s)=>(d(),l(V,null,[z(h(pe),{title:`Chat with ${x.user.name}`},null,8,["title"]),z(we,{breadcrumbs:q},{default:ge(()=>[t("div",Me,[t("div",$e,[b.value?(d(),l("div",Ce,[...s[1]||(s[1]=[t("div",{class:"flex items-center"},[t("div",{class:"relative mr-1"},[t("div",{class:"w-1.5 h-1.5 md:w-2 md:h-2 bg-green-500 rounded-full"}),t("div",{class:"absolute w-1.5 h-1.5 md:w-2 md:h-2 bg-green-500 rounded-full animate-ping"})]),t("span",{class:"truncate"},"Online")],-1)])])):(d(),l("div",De," Last seen "+u(ae(x.user.last_seen_at)),1))]),_.value?(d(),l("div",Se,[t("div",Ee,[s[3]||(s[3]=t("div",{class:"flex-shrink-0"},[t("div",{class:"animate-spin rounded-full h-5 w-5 md:h-6 md:w-6 border-b-2 border-blue-500"})],-1)),t("div",Ue,[s[2]||(s[2]=t("p",{class:"text-sm font-medium text-blue-700"},"Uploading file...",-1)),t("div",je,[t("div",{class:"bg-blue-600 h-1.5 md:h-2 rounded-full transition-all duration-300",style:he({width:v.value+"%"})},null,4)]),t("p",Be,u(v.value)+"%",1)])])])):w("",!0),t("div",Te,[t("div",Ne,[t("div",Ie,[t("div",{class:f(["flex-shrink-0 h-10 w-10 md:h-12 md:w-12 rounded-full flex items-center justify-center text-white font-medium text-sm md:text-base",H(x.user.id)])},u(G(x.user.name)),3),t("div",Oe,[t("h2",Re,u(x.user.name),1),t("p",Fe,u(x.user.email),1),U.value?(d(),l("div",Pe,[...s[4]||(s[4]=[t("div",{class:"flex space-x-1"},[t("div",{class:"w-1.5 h-1.5 md:w-2 md:h-2 bg-green-500 rounded-full animate-bounce"}),t("div",{class:"w-1.5 h-1.5 md:w-2 md:h-2 bg-green-500 rounded-full animate-bounce",style:{"animation-delay":"0.1s"}}),t("div",{class:"w-1.5 h-1.5 md:w-2 md:h-2 bg-green-500 rounded-full animate-bounce",style:{"animation-delay":"0.2s"}})],-1),t("span",{class:"truncate"},"typing...",-1)])])):w("",!0)])]),t("div",{class:"flex space-x-2 md:space-x-2"},[t("button",{onClick:le,class:"flex-1 md:flex-none px-3 py-1.5 md:px-4 md:py-2 text-xs md:text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors"}," Refresh "),t("button",{onClick:Z,class:"flex-1 md:flex-none px-3 py-1.5 md:px-4 md:py-2 text-xs md:text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors"}," Clear Chat ")])])]),t("div",{ref_key:"messagesContainer",ref:D,onDragover:te,onDrop:se,class:"bg-white rounded-lg shadow h-[60vh] md:h-96 overflow-y-auto p-3 md:p-4 mb-3 md:mb-4 relative"},[w("",!0),t("div",Le,[(d(!0),l(V,null,fe(p.value,o=>(d(),l("div",{key:o.id,class:f(["flex",o.sender_id===h(r).props.auth.user.id?"justify-end":"justify-start"])},[t("div",ze,[o.reply_to?(d(),l("div",Ve,[s[6]||(s[6]=t("div",{class:"text-xs text-gray-500 mb-1"},"Replying to",-1)),t("div",Ae,[t("p",Je,u(o.replied_to?.body||o.reply_to_body||"Original message"),1)])])):w("",!0),o.type&&o.type!=="text"?(d(),l("div",{key:1,class:f(["px-3 py-2 md:px-4 md:py-3 rounded-lg cursor-pointer transition-all hover:shadow-md",o.sender_id===h(r).props.auth.user.id?"bg-blue-100 border border-blue-200":"bg-gray-100 border border-gray-200"]),onClick:a=>ne(o)},[o.is_image?(d(),l("div",qe,[t("img",{src:o.file_url,alt:o.file_name,class:"rounded-lg max-h-32 md:max-h-48 w-auto mx-auto object-cover cursor-pointer hover:opacity-90 transition-opacity",onClick:xe(a=>e.window.open(o.file_url,"_blank"),["stop"])},null,8,Ge)])):(d(),l("div",He,[t("div",Ke,u(oe(o.mime_type)),1),t("div",We,[t("p",{class:f(["text-xs md:text-sm font-medium truncate",o.sender_id===h(r).props.auth.user.id?"text-blue-800":"text-gray-800"])},u(o.file_name),3),t("p",{class:f(["text-xs",o.sender_id===h(r).props.auth.user.id?"text-blue-600":"text-gray-600"])},u(o.file_size),3)]),t("div",Xe,[(d(),l("svg",{class:f(["w-4 h-4 md:w-5 md:h-5",o.sender_id===h(r).props.auth.user.id?"text-blue-500":"text-gray-500"]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[...s[7]||(s[7]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"},null,-1)])],2))])])),t("p",{class:f(["text-xs mt-1 md:mt-2",o.sender_id===h(r).props.auth.user.id?"text-blue-600":"text-gray-600"])},u(o.body)+" â€¢ "+u(new Date(o.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})),3)],10,Ye)):(d(),l("div",{key:2,class:f(["px-3 py-2 md:px-4 md:py-2 rounded-lg cursor-pointer hover:opacity-90 transition-opacity",o.sender_id===h(r).props.auth.user.id?"bg-blue-500 text-white":"bg-gray-200 text-gray-900"]),onClick:a=>X(o)},[t("p",Qe,u(o.body),1),t("p",{class:f(["text-xs mt-1 flex items-center justify-between",o.sender_id===h(r).props.auth.user.id?"text-blue-100":"text-gray-500"])},[t("span",null,u(new Date(o.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})),1),s[8]||(s[8]=t("span",{class:"ml-2 hidden md:inline"},"Click to reply",-1)),s[9]||(s[9]=t("span",{class:"ml-2 md:hidden"},"â†©ï¸",-1))],2)],10,Ze))])],2))),128)),p.value.length===0?(d(),l("div",es,[...s[10]||(s[10]=[t("div",{class:"mb-3 md:mb-4"},[t("svg",{class:"w-12 h-12 md:w-16 md:h-16 text-gray-300 mx-auto",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})])],-1),t("p",{class:"text-sm md:text-base text-gray-500"},"No messages yet. Start the conversation!",-1),t("p",{class:"text-xs md:text-sm text-gray-400 mt-1 md:mt-2"},"You can also drag & drop files here",-1)])])):w("",!0)])],544),g.value?(d(),l("div",ss,[t("div",ts,[t("div",os,[t("div",ns,[s[11]||(s[11]=t("svg",{class:"w-3 h-3 md:w-4 md:h-4 text-blue-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"})],-1)),t("p",as,"Replying to "+u(K(g.value)),1)]),t("div",is,[t("p",rs,u(g.value.body),1)])]),t("button",{onClick:B,class:"ml-1 md:ml-2 p-0.5 md:p-1 text-blue-500 hover:text-blue-700 hover:bg-blue-100 rounded-full transition-colors flex-shrink-0",title:"Cancel reply"},[...s[12]||(s[12]=[t("svg",{class:"w-4 h-4 md:w-5 md:h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])])])):w("",!0),t("div",ls,[t("div",ds,[t("input",{type:"file",ref_key:"fileInput",ref:E,onChange:ee,accept:"image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar",class:"hidden"},null,544),t("button",{onClick:Q,class:"p-1.5 md:p-2 text-gray-500 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition-colors flex-shrink-0",title:"Upload file"},[...s[13]||(s[13]=[t("svg",{class:"w-5 h-5 md:w-6 md:h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"})],-1)])]),ve(t("input",{type:"text","onUpdate:modelValue":s[0]||(s[0]=o=>y.value=o),onInput:W,onKeyup:be(F,["enter"]),placeholder:"Type a message...",class:"flex-1 px-3 py-1.5 md:px-4 md:py-2 dark:text-gray-700 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm md:text-base"},null,544),[[ye,y.value]]),t("button",{onClick:F,disabled:!y.value.trim()&&!_.value,class:"px-4 py-1.5 md:px-6 md:py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-sm md:text-base flex-shrink-0"}," Send ",8,us)]),s[14]||(s[14]=t("div",{class:"mt-2 text-xs text-gray-500 hidden md:block"},[t("p",null,"ðŸ“· Images: JPEG, PNG, GIF, WebP, SVG, BMP (Max 10MB)"),t("p",null,"ðŸ“Ž Documents: PDF, Word, Excel, PowerPoint, TXT, CSV, ZIP, RAR (Max 20MB)")],-1)),s[15]||(s[15]=t("div",{class:"mt-1 text-[10px] md:text-xs text-gray-500 md:hidden"},[t("p",null,"ðŸ“· Images & ðŸ“Ž Documents (Max 20MB)")],-1))])])]),_:1})],64))}};export{ks as default};
